########################################################################
# Collect, store and print test result info
########################################################################

parameters:
  condition: always()
  continueOnError: true
  TRIAL_ID: ''

steps:
  - script: |
      # If Trial ID is defined via parameters, we will use it.
      # Otherwise, we will initialize a variable and will use it within the job
      if [ -n "$PAR_TRIAL_ID" ] ; then
        TRIAL_ID=$PAR_TRIAL_ID
      else
        if [ -z "$TRIAL_ID" ] ; then
          TRIAL_ID=1
        else
          TRIAL_ID=$(($TRIAL_ID+1))
        fi
        echo "##vso[task.setvariable variable=TRIAL_ID]$TRIAL_ID"
      fi
      # If we are using a matrix, we also need a job name for the unique
      # suffix. Otherwise, only trial ID
      if [ "$SYSTEM_JOBDISPLAYNAME" == "Job" ] ; then
        SUFFIX=$TRIAL_ID
      else
        SUFFIX=${SYSTEM_JOBDISPLAYNAME}.${TRIAL_ID}
      fi
      echo "##vso[task.setvariable variable=SUFFIX]$SUFFIX"
      summary_dir=$(Build.ArtifactStagingDirectory)/summary-$(Build.BuildNumber).$SUFFIX
      details_dir=$(Build.ArtifactStagingDirectory)/data-$(Build.BuildNumber).$SUFFIX
      repro_dir=$(Build.ArtifactStagingDirectory)/repro-$(Build.BuildNumber).$SUFFIX
      rm -rf $summary_dir $details_dir $repro_dir
      mkdir -p $summary_dir $details_dir $repro_dir
      cp $ENV_LOGDIR/trial.log $ENV_RQG_HOME/rqg.info $ENV_BASEDIR/server.info $ENV_TOOLBOX_DIR/toolbox.info $summary_dir/
      cp `find $ENV_LOGDIR -name mysql*err* | xargs` $summary_dir/
      cp `find $ENV_LOGDIR -name mbackup*log* | xargs` $summary_dir/
      cp $ENV_LOGDIR/vardir/mysql.log $repro_dir/
      for c in `find $ENV_LOGDIR -name core*` ; do
        echo "#################### $c ####################" >> $summary_dir/stacktraces
        echo "#################### $c ####################" >> $details_dir/threads
        echo "#################### $c ####################" >> $details_dir/threads_full
        binary=`gdb --batch --eval-command="bt" 1 $c 2>&1 | grep 'Core was generated by' | sed -e 's/^Core was generated by \`\([^ ]*\) .*/\1/'`
        echo $binary >> $summary_dir/stacktraces
        echo $binary >> $details_dir/threads
        echo $binary >> $details_dir/threads_full
        gdb --batch --eval-command="bt" $binary $c  | grep -v 'New LWP' >> $summary_dir/stacktraces
        gdb --batch --eval-command="thread apply all bt" $binary $c >> $details_dir/threads
        gdb --batch --eval-command="thread apply all bt full" $binary $c >> $details_dir/threads_full
      done
      tar zcf $details_dir/logs.tar.gz $ENV_LOGDIR
      echo "####################################################################################################" >> $summary_dir/test_report
      echo "Test $SUFFIX" >> $summary_dir/test_report
      res=`grep 'exited with exit status' $summary_dir/trial.log | sed -e 's/.*exited with exit status STATUS_\([A-Z_]*\).*/\1/'`
      echo "Test result:" $res >> $summary_dir/test_report
      echo "PipelineId-BuildId:" $(System.DefinitionId)-$(Build.BuildId) >> $summary_dir/test_report
      echo "-------------------------------------" >> $summary_dir/test_report
      echo >> $summary_dir/test_report
      echo `cat $summary_dir/server.info` >> $summary_dir/test_report
      echo `cat $summary_dir/rqg.info` `cat $summary_dir/toolbox.info` >> $summary_dir/test_report
      echo >> $summary_dir/test_report
      grep -A 1 'Final command line' $summary_dir/trial.log >> $summary_dir/test_report
      echo >> $summary_dir/test_report
      perl $ENV_TOOLBOX_DIR/travis/check_for_known_bugs.pl $summary_dir/mysql*.err* $summary_dir/stacktraces $summary_dir/trial.log >> $summary_dir/test_report
      echo >> $summary_dir/test_report
      for f in $summary_dir/mysql*.err* ; do
        echo "========== $f ==========" >> $summary_dir/test_report
        cat $f | grep -v -f $ENV_TOOLBOX_DIR/travis/server_warnings.supp | grep -v "\[Note\]" | grep -v "^$" | cut -c 1-4096 >> $summary_dir/test_report
        echo >> $summary_dir/test_report
      done
      echo "####################################################################################################" >> $summary_dir/test_report
      cat $summary_dir/test_report
      cat $summary_dir/server.info >> $repro_dir/repro.info
      echo $ENV_MYSQLD_OPTIONS >> $details_dir/repro.info
      if echo $ENV_RQG_OPTIONS | grep ps-protocol > /dev/null ; then
        echo "--ps-protocol" >> $details_dir/repro.info
      fi
    displayName: 'Test report'
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
    env:
      PAR_TRIAL_ID: ${{ parameters.TRIAL_ID }}

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: test-$(Build.BuildNumber).$(SUFFIX)
    displayName: 'Store test results'
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
