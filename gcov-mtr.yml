########################################################################
# GCOV report for MTR tests
########################################################################

trigger: none

# Expects SERVER_BRANCH in the environment

jobs:

#########
- job: Build
  pool:
    vmImage: 'Ubuntu 16.04'
  timeoutInMinutes: 0
  strategy:
    parallel: 1

  steps:

  - template: steps/env.yml

  - template: steps/install-deb-packages.yml
    parameters:
      INSTALLATION_SET: 'all'
      EXTRA_PACKAGES: 'lcov'

  - bash: |
      set -x
      if [ -z "$ENV_SERVER_BRANCH" ]; then
        echo "##vso[task.complete result=Failed]\"SERVER_BRANCH\" has not been specified"
      fi
      git clone $SERVER_REPO --branch=$ENV_SERVER_BRANCH $HOME/server
      cd $HOME/server
      current_revno=`git log -1 --abbrev=8 --pretty="%h"`
      if [ -n "$BASELINE_REVISION" ]; then
        baseline_revno=$BASELINE_REVISION
      elif wget $FTP_DOWNLOAD/gcov-last-revno.$ENV_SERVER_BRANCH ; then
        baseline_revno=`cat gcov-last-revno.$ENV_SERVER_BRANCH`
      else
        baseline_revno=`git log -1 ${current_revno}^ --abbrev=8 --pretty="%h"`
      fi
      echo "Baseline revision: $baseline_revno Current_revison: $current_revno"
      if [[ "$baseline_revno" =~ ^"$current_revno" ]] ; then
        echo "##vso[task.complete result=Skipped]Baseline revision is the same as current revision"
      else
        echo $baseline_revno > baseline.revision
      fi
    displayName: 'Prepare and clone'
    env:
      FTP_DOWNLOAD: 'ftp://perro.askmonty.org/public/azure'
      SERVER_REPO: 'https://github.com/MariaDB/server'
    name: prep

  # Build the server in-source
  - bash: |
      set -x
      sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 50
      sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-7 50
      sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-7 50
      cd $HOME/server
      cmake_options="$ENV_CMAKE_OPTIONS -DCMAKE_BUILD_TYPE=Debug -DENABLE_GCOV=ON"
      cmake . $cmake_options
      make -j5
      for f in pars0lex.l lexyy.cc pars0grm.cc pars0grm.y ; do
        cp storage/innobase/pars/$f storage/innobase/CMakeFiles/innobase.dir/pars/
        if [ -e storage/xtradb/pars/$f ] ; then
          cp storage/xtradb/pars/$f storage/xtradb/CMakeFiles/xtradb.dir/pars/
        fi
      done
      for f in fts0pars.y fts0pars.cc fts0blex.cc fts0blex.l fts0tlex.cc fts0tlex.l ; do
        cp storage/innobase/fts/$f storage/innobase/CMakeFiles/innobase.dir/fts/
        if [ -e storage/xtradb/fts/$f ] ; then
          cp storage/xtradb/fts/$f storage/xtradb/CMakeFiles/xtradb.dir/fts/
        fi
      done
      echo $ENV_SERVER_BRANCH `git log -1 --abbrev=8 --pretty="%h"` > $HOME/server/server.info
      echo $cmake_options >> $HOME/server/server.info
      lcov --directory `pwd` --zerocounters
      cd $HOME/server/mysql-test
      perl mysql-test-run.pl --mem --verbose-restart --force --max-test-fail=0 --retry=0 --noreorder federated.federated_server main.alter_table-big main.count_distinct3 main.create-big main.create_delayed main.events_stress main.events_time_zone main.file_contents main.information_schema-big main.log_tables-big main.lowercase_table4 main.max_statement_time main.merge-big main.myisam-big main.mysql_client_test main.mysql_client_test_nonblock main.mysql_embedded main.mysqlbinlog_row_big main.mysqldump main.partition_open_files_limit main.read_many_rows_innodb main.selectivity_innodb main.ssl-big main.sum_distinct-big main.tablespace main.type_newdecimal-big main.openssl_6975 federated.federated_partition,X,innodb federated.federated_transactions,X,innodb federated.federated_innodb,X,innodb federated.net_thd_crash-12951,X,innodb federated.federated_innodb,innodb,old federated.net_thd_crash-12951,innodb,old federated.federated_archive,X federated.federated_archive,old federated.federated_debug,X federated.federated_debug,old federated.assisted_discovery,X federated.federatedx,X federated.error_on_close-8313,X federated.federated,X federated.federated_bug_13118,X federated.federated_bug_25714,X federated.federated_bug_32426,X federated.federated_bug_35333,X federated.federated_bug_585688,X federated.federated_maybe_16324629,X federated.net_thd_crash-12725,X federated.error_on_close-8313,old federated.federated,old federated.federated_bug_13118,old federated.federated_bug_25714,old federated.federated_bug_32426,old federated.federated_bug_35333,old federated.federated_bug_585688,old federated.federated_maybe_16324629,old federated.net_thd_crash-12725,old main.connect main.connect2 main.pool_of_threads main.ipv4_and_ipv6 main.ipv4_as_ipv6 main.ipv6 main.sp_trans_log,innodb main.tc_heuristic_recover,innodb main.mysqlbinlog_row_minimal main.stat_tables_rbr,innodb main.ctype_cp932_binlog_row main.mysqlbinlog_row_compressed main.mysqlbinlog-innodb,innodb main.partition_innodb_stmt,innodb main.session_tracker_last_gtid,innodb main.mysqlbinlog main.mysqlbinlog_stmt_compressed main.set_statement_notembedded_binlog main.partition_binlog_stmt main.lock_tables_lost_commit,innodb main.ctype_filesystem main.ctype_latin1_de main.ps main.mysqlcheck,innodb main.type_varchar main.upgrade main.ctype_ucs2_query_cache main.ctype_ucs2_def main.ctype_utf16_def main.lowercase_utf8 main.bug47671 main.ctype_utf8_def_upgrade main.ctype_ldml main.grant main.grant2 main.grant4 main.date_formats main.lock_sync,innodb main.mysqldump-max,innodb main.partition_innodb_semi_consistent,innodb main.ctype_utf8mb4_innodb,innodb main.crash_commit_before,innodb main.ctype_utf8,innodb main.ctype_utf8mb4,innodb main.implicit_commit,innodb main.mdl_sync,innodb main.ps_3innodb,innodb main.strict,innodb main.bootstrap main.userstat,innodb main.enforce_storage_engine_opt main.events_bugs main.events_restart main.events_logs_tests main.log_state_bug33693 main.subselect_mat_cost main.log_tables main.log_state main.create_or_replace,innodb main.mysql_upgrade-6984 main.innodb_load_xa main.innodb_ignore_builtin main.init_file main.init_file_longline_3816 main.init_connection_query_cache main.init_connect main.flush_block_commit_notembedded,innodb main.innodb_mysql_lock2,innodb main.bug39022,innodb main.commit_1innodb,innodb main.create_select_tmp,innodb main.sp_trans,innodb main.xa_binlog,innodb main.partition_innodb,innodb main.partition_exchange,innodb main.alter_table_online,innodb main.innodb_mysql_sync,innodb main.mysql_upgrade,innodb main.partition_alter,innodb main.partition_cache,innodb main.partition_cache_innodb,innodb main.partition_datatype,innodb main.partition_debug_sync,innodb main.partition_explicit_prune,innodb main.partition_innodb_plugin,innodb main.truncate-stale-6500,innodb main.type_datetime_hires,innodb main.information_schema_all_engines,innodb main.bug46760,innodb main.row-checksum-old,innodb main.row-checksum,innodb main.concurrent_innodb_unsafelog,innodb main.unsafe_binlog_innodb,innodb main.concurrent_innodb_safelog,innodb main.mdl,innodb main.stat_tables_innodb_debug,innodb main.lowercase_mixed_tmpdir_innodb,innodb main.plugin_auth,innodb main.plugin_innodb,innodb main.temp_table,innodb main.stat_tables_innodb,innodb main.stat_tables_par_innodb,innodb main.statistics,innodb main.statistics_index_crash-7362,innodb main.alter_table,innodb main.alter_table_autoinc-5574,innodb main.alter_table_errors,innodb main.alter_table_trans,innodb main.analyze_stmt_orderby,innodb main.auto_increment_ranges_innodb,innodb main.cache_innodb,innodb main.check_constraint_innodb,innodb main.commit,innodb main.consistent_snapshot,innodb main.ctype_uca_innodb,innodb main.ctype_upgrade,innodb main.deadlock_innodb,innodb main.endspace,innodb main.events_trans,innodb main.events_trans_notembedded,innodb main.explain_json_innodb,innodb main.ext_key_noPK_6794,innodb main.fast_prefix_index_fetch_innodb,innodb main.flush-innodb,innodb main.flush-innodb-notembedded,innodb main.flush_block_commit,innodb main.flush_read_lock,innodb main.flush_read_lock_kill,innodb main.foreign_key,innodb main.func_analyse,innodb main.func_group_innodb,innodb main.func_rollback,innodb main.function_defaults_innodb,innodb main.gis-alter_table_online,innodb main.group_by_innodb,innodb main.group_min_max_innodb,innodb main.host_cache_size_functionality,innodb main.index_intersect_innodb,innodb main.index_merge_innodb,innodb main.information_schema,innodb main.information_schema_inno,innodb main.innodb_bug878769,innodb main.innodb_ext_key,innodb main.innodb_group,innodb main.innodb_icp,innodb main.innodb_mrr_cpk,innodb main.innodb_mysql_lock,innodb main.innodb_utf8,innodb main.insert_innodb,innodb main.join_cache,innodb main.join_outer_innodb,innodb main.keyread,innodb main.loaddata_autocom_innodb,innodb main.locked_temporary-5955,innodb main.log_tables_upgrade,innodb main.lowercase_table2,innodb main.mdev13607,innodb main.merge_innodb,innodb main.mrr_derived_crash_4610,innodb main.multi_update_innodb,innodb main.mysql_upgrade_noengine,innodb main.mysql_upgrade_ssl,innodb main.order_by_innodb,innodb main.order_by_optimizer_innodb,innodb main.parser_bug21114_innodb,innodb main.progress_976225,innodb main.ps_innodb,innodb main.ps_qc_innodb,innodb main.query_cache_innodb,innodb main.range,innodb main.range_innodb,innodb main.range_mrr_icp,innodb main.range_vs_index_merge_innodb,innodb main.read_only_innodb,innodb main.reopen_temp_table,innodb main.rowid_order_innodb,innodb main.show_explain,innodb main.show_explain_non_select,innodb main.single_delete_update_innodb,innodb main.sp-group,innodb main.sp-innodb,innodb main.ssl_and_innodb,innodb main.stat_tables_disabled,innodb main.strict_autoinc_2innodb,innodb main.subselect-crash_15755,innodb main.subselect2,innodb main.subselect_innodb,innodb main.subselect_sj2,innodb main.subselect_sj2_jcl6,innodb main.subselect_sj2_mat,innodb main.system_mysql_db_fix40123,innodb main.system_mysql_db_fix50030,innodb main.system_mysql_db_fix50117,innodb main.trigger-trans,innodb main.type_bit_innodb,innodb main.type_num_innodb,innodb main.type_temporal_innodb,innodb main.type_time_hires,innodb main.type_timestamp_hires,innodb main.uniques_crash-7912,innodb main.update,innodb main.update_innodb,innodb main.warnings_debug,innodb main.xa,innodb main.xtradb_mrr,innodb main.plugin_loaderr main.myisam-blob main.key_cache main.select_pkeycache main.ctype_cp932_binlog_stm main.partition_binlog main.multi_update main.compound main.create_drop_binlog main.ctype_gbk_binlog main.mysql_binary_mode main.mysql_upgrade_view main.mysqlbinlog_raw_mode main.mysqldump_restore main.mysqltest main.ps_change_master main.trigger_wl3253 main.user_var-binlog main.show_check main.status main.multi_statement main.union main.explain_slowquerylog main.analyze_stmt_slow_query_log main.partition_blackhole main.blackhole main.mysqldump-compat main.func_encrypt main.ssl_7937,nossl main.auth_named_pipe main.named_pipe main.partition_not_blackhole main.partition_example main.partition main.partition_not_windows main.assign_key_cache main.ctype_partitions main.ctype_uca_partitions main.explain_json_format_partitions main.explain_non_select main.huge_frm-6224 main.information_schema_part main.lock main.partition_bug18198 main.partition_cache_myisam main.partition_charset main.partition_column main.partition_column_prune main.partition_csv main.partition_default main.partition_error main.partition_grant main.partition_hash main.partition_key_cache main.partition_list main.partition_mgm main.partition_mgm_err main.partition_mgm_err2 main.partition_myisam main.partition_order main.partition_pruning main.partition_range main.partition_rename_longfilename main.partition_symlink main.partition_sync main.partition_truncate main.partition_utf8 main.partition_windows main.stat_tables_partition main.view main.mysql_client_test_comp main.ssl_7937,x509v3 main.ssl_verify_ip main.ssl_7937,ssl main.plugin_load main.plugin_load_option main.cte_recursive main.selectivity main.stat_tables_myisam_debug main.errors main.func_gconcat main.slowlog_enospace-10508 main.user_var main.shm main.warnings main.skip_log_bin main.partition_disabled main.variables-notembedded main.ssl_8k_key main.ssl_timeout-9836 main.lowercase_mixed_tmpdir main.grant_lowercase main.lowercase_view main.lowercase_table main.lowercase_table_grant main.lowercase_table_qcache main.variables main.user_limits main.count_distinct2 main.multi_update_tiny_hash main.myisam_recover main.myisam main.merge_mmap main.old-mode main.plugin_auth_qa main.plugin_auth_qa_1 main.plugin_auth_qa_2 main.plugin_auth_qa_3 main.plugin_maturity main.handlersocket main.plugin main.plugin_not_embedded main.table_options-5867 main.truncate_badse main.query_cache_notembedded main.bug58669 main.grant3 main.secure_file_priv_win main.myisam_crash_before_flush_keys main.skip_grants main.udf_skip_grants main.flush2 main.mysqldump-no-binlog main.kill-2 main.skip_name_resolve main.mysqlslap main.ssl_crl,file main.ssl_crl,path main.sysdate_is_now main.no-threads main.multi_update_big main.long_tmpdir main.error_simulation main.trans_read_only main.selectivity_no_engine main.stat_tables main.stat_tables_par main.join_outer main.join_outer_jcl6 main.query_cache main.query_cache_debug main.1st main.aborted_clients main.adddate_454 main.alias main.almost_full main.alter_table_mdev539_maria main.alter_table_mdev539_myisam main.alter_user main.analyze main.analyze_debug main.analyze_format_json main.analyze_stmt main.analyze_stmt_privileges main.analyze_stmt_privileges2 main.ansi main.assign_key_cache_debug main.auto_increment main.auto_increment_ranges_myisam main.bad_frm_crash_5029 main.bench_count_distinct main.bigint main.binary main.binary_to_hex main.blackhole_plugin main.bool main.bug12427262 main.bug13633383 main.bulk_replace main.cache_temporal_4265 main.case main.cast main.change_user main.change_user_notembedded main.charset_client_win main.check main.check_constraint main.check_constraint_show main.client_xml main.comment_column main.comment_column2 main.comment_index main.comment_table main.comments main.compare main.compress main.connect_debug main.constraints main.contributors main.count_distinct main.create main.create-uca main.create_drop_db main.create_drop_event main.create_drop_function main.create_drop_index main.create_drop_procedure main.create_drop_role main.create_drop_server main.create_drop_trigger main.create_drop_udf main.create_drop_user main.create_drop_view main.create_not_windows main.create_or_replace_permission main.create_replace_tmp main.create_user main.create_w_max_indexes_128 main.create_w_max_indexes_64 main.cte_grant main.cte_nonrecursive main.cte_recursive_not_embedded main.ctype_ascii main.ctype_big5 main.ctype_binary main.ctype_collate main.ctype_cp1250_ch main.ctype_cp1251 main.ctype_cp850 main.ctype_cp932 main.ctype_create main.ctype_errors main.ctype_eucjpms main.ctype_euckr main.ctype_filename main.ctype_gb2312 main.ctype_gbk main.ctype_gbk_export_import main.ctype_hebrew main.ctype_latin1 main.ctype_latin2 main.ctype_latin2_ch main.ctype_like_range main.ctype_many main.ctype_mb main.ctype_nopad_8bit main.ctype_recoding main.ctype_sjis main.ctype_swe7 main.ctype_tis620 main.ctype_uca main.ctype_ucs main.ctype_ucs2_uca main.ctype_ujis main.ctype_ujis_ucs2 main.ctype_utf16 main.ctype_utf16_uca main.ctype_utf16le main.ctype_utf32 main.ctype_utf32_uca main.ctype_utf8_uca main.ctype_utf8mb4_heap main.ctype_utf8mb4_myisam main.ctype_utf8mb4_uca main.datetime_456 main.ddl_i18n_koi8r main.ddl_i18n_utf8 main.debug_sync main.default main.default_debug main.default_session main.default_storage_engine main.delayed main.delete main.delete_returning main.delete_returning_grant main.delimiter_command_case_sensitivity main.deprecated_features main.derived main.derived_cond_pushdown main.derived_opt main.derived_view main.dirty_close main.distinct main.drop main.drop-no_root main.drop_bad_db_type main.dyncol main.empty_server_name-8224 main.empty_table main.empty_user_table main.enforce_storage_engine main.engine_error_in_alter-8453 main.events_1 main.events_2 main.events_embedded main.events_grant main.events_microsec main.events_scheduling main.events_slowlog main.execution_constants main.explain main.explain_json main.failed_auth_3909 main.failed_auth_unixsocket main.features main.filesort_bad_i_s-7585 main.filesort_debug main.fix_priv_tables main.flush main.flush_table main.frm_bad_row_type-7333 main.fulltext main.fulltext2 main.fulltext3 main.fulltext_cache main.fulltext_charsets main.fulltext_derived_4257 main.fulltext_derived_4316 main.fulltext_distinct main.fulltext_left_join main.fulltext_multi main.fulltext_order_by main.fulltext_update main.fulltext_var main.func_compress main.func_concat main.func_crypt main.func_date_add main.func_default main.func_des_encrypt main.func_digest main.func_encrypt_nossl main.func_encrypt_ucs2 main.func_equal main.func_group main.func_hybrid_type main.func_if main.func_in main.func_isnull main.func_json main.func_like main.func_math main.func_misc main.func_op main.func_regexp main.func_regexp_pcre main.func_regexp_pcre_debug main.func_sapdb main.func_set main.func_str main.func_system main.func_test main.func_time main.func_time_hires main.func_timestamp main.func_weight_string main.function_defaults main.function_defaults_notembedded main.gcc296 main.get_diagnostics main.gis main.gis-debug main.gis-json main.gis-loaddata main.gis-precise main.gis-rt-precise main.gis-rtree main.gis_notembedded main.grant5 main.grant_4332 main.grant_cache_no_prot main.grant_cache_ps_prot main.grant_explain_non_select main.grant_lowercase_fs main.grant_not_windows main.greedy_optimizer main.group_by main.group_by_null main.group_min_max main.handler_read_last main.having main.help main.implicit_char_to_num_conversion main.in_datetime_241 main.index_intersect main.index_merge_myisam main.information_schema2 main.information_schema_chmod main.information_schema_db main.information_schema_linux main.information_schema_parameters main.information_schema_prepare main.information_schema_routines main.information_schema_stats main.init_file_set_password-7656 main.insert main.insert_notembedded main.insert_select main.insert_update main.insert_update_autoinc-7150 main.join main.join_crash main.join_nested main.join_nested_jcl6 main.join_optimizer main.key main.key_diff main.key_primary main.keywords main.kill main.kill_processlist-6619 main.kill_query-6728 main.last_value main.limit main.limit_rows_examined main.loaddata main.loadxml main.locale main.lock_multi main.lock_multi_bug38499 main.lock_multi_bug38691 main.log_errchk main.log_slow main.log_slow_debug main.log_tables_debug main.lowercase_fs_off main.lowercase_fs_on main.lowercase_table5 main.mdev-504 main.mdev316 main.mdev375 main.mdev6830 main.mdev_14586 main.mdev_19276 main.merge main.merge_debug main.metadata main.mix2_myisam main.mix2_myisam_ucs2 main.mrr_icp_extra main.multi_update_debug main.myisam-optimize main.myisam-system main.myisam_debug main.myisam_enable_keys-10506 main.myisam_explain_non_select_all main.myisam_icp main.myisam_icp_notembedded main.myisam_mrr main.myisam_optimize main.myisampack main.mysql main.mysql-bug41486 main.mysql-bug45236 main.mysql5613mysql main.mysql57_virtual main.mysql_comments main.mysql_cp932 main.mysql_locale_posix main.mysql_not_windows main.mysql_protocols main.mysql_tzinfo_to_sql_symlink main.mysql_upgrade_no_innodb main.mysqladmin main.mysqld--defaults-file
      lcov --version
      gcov --version
      gcc --version
      cd $HOME
      git clone https://github.com/elenst/mariadb-toolbox
      cd server
      rm -rf $BUILD_ARTIFACTSTAGINGDIRECTORY/*
      infodir=$BUILD_ARTIFACTSTAGINGDIRECTORY/gcov_info
      mkdir $infodir
      baseline_revno=`cat baseline.revision`
      git diff $baseline_revno > $infodir/gcov.diff
      lcov --rc lcov_branch_coverage=1 --quiet --directory $HOME/server --capture --output-file $infodir/lcov.info
      perl $HOME/mariadb-toolbox/scripts/coverage_for_patch.pl --basedir=$HOME/server --diff-file=$infodir/gcov.diff --lcov-info=$infodir/lcov.info --branch-info 1>$infodir/coverage 2>$infodir/missings
      echo "###################"
      echo "# Missing coverage"
      echo "###################"
      cat $infodir/missings
      echo
      perl $HOME/mariadb-toolbox/scripts/coverage_summary.pl $infodir/lcov.info > $infodir/coverage_summary
      echo "###################"
      echo "##### GCOV summary"
      echo "###################"
      cat $infodir/coverage_summary
      echo
    name: gcov_report
    displayName: 'GCOV report'

  - publish: $(Build.ArtifactStagingDirectory)
    artifact: gcov_info
    name: publish_gcov_info

  - bash: |
      rm -rf $BUILD_ARTIFACTSTAGINGDIRECTORY/*
      mv $HOME/server/baseline.revision $BUILD_ARTIFACTSTAGINGDIRECTORY/gcov_baseline_revision_$SERVER_BRANCH
    name: store_baseline

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: gcov_baseline_revision
    displayName: 'Publish baseline'

#########
# Upload to FTP
- template: jobs/upload-to-ftp.yml
  parameters:
    name: 'Upload_new_baseline_to_FTP'
    artifactName: gcov_baseline_revision
    dependencies:
    - 'Build'
    condition: succeeded()
