########################################################################
# Run single RQG test and collect test result information
########################################################################

parameters:
  condition: succeeded()
  continueOnError: true
  TRIAL_OPTIONS: ''
  TRIAL_ID: ''

steps:
  - script: |
      mkdir -p $ENV_LOGDIR
      set -xo pipefail
      cd $ENV_RQG_HOME
      perl ./runall-new.pl \
        --basedir=$ENV_BASEDIR \
        --vardir=$ENV_LOGDIR/vardir \
        $ENV_RQG_OPTIONS \
        $PAR_TRIAL_OPTIONS \
        2>&1 | tee $ENV_LOGDIR/trial.log
    displayName: RQG test
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
    env:
      PAR_TRIAL_OPTIONS: ${{ parameters.TRIAL_OPTIONS }}

  - template: rqg-test-result.yml
    parameters:
      condition: ${{ parameters.condition }}
      continueOnError: ${{ parameters.continueOnError }}
      TRIAL_ID: ${{ parameters.TRIAL_ID }}
