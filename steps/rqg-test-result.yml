########################################################################
# Collect, store and print test result info
########################################################################

parameters:
  condition: always()
  continueOnError: true
  TRIAL_NO: ''

steps:
  - script: |
      # If Trial ID is defined via parameters, we will use it.
      # Otherwise, we will initialize a variable and will use it within the job
      if [ -n "$PAR_TRIAL_NO" ] ; then
        TRIAL_NO=$PAR_TRIAL_NO
      else
        if [ -z "$TRIAL_NO" ] ; then
          TRIAL_NO=1
        else
          TRIAL_NO=$(($TRIAL_NO+1))
        fi
        echo "##vso[task.setvariable variable=TRIAL_NO]$TRIAL_NO"
      fi
      # If we are using a matrix, we also need a job name for the unique
      # suffix. Otherwise, only trial ID
      if [ "$SYSTEM_JOBDISPLAYNAME" == "Job" ] ; then
        TEST_ID=$TRIAL_NO
      else
        TEST_ID=${SYSTEM_JOBDISPLAYNAME}.${TRIAL_NO}
      fi
      echo "##vso[task.setvariable variable=TEST_ID]$TEST_ID"
      rm -rf $(Build.ArtifactStagingDirectory)/*
      summary_dir=$(Build.ArtifactStagingDirectory)/summary-$(Build.BuildNumber).$TEST_ID
      details_dir=$(Build.ArtifactStagingDirectory)/data-$(Build.BuildNumber).$TEST_ID
      repro_dir=$(Build.ArtifactStagingDirectory)/repro-$(Build.BuildNumber).$TEST_ID
      mkdir -p $summary_dir $details_dir $repro_dir
      cp $ENV_LOGDIR/trial.log $ENV_RQG_HOME/rqg.info $ENV_BASEDIR/server.info $ENV_TOOLBOX_DIR/toolbox.info $summary_dir/
      cp `find $ENV_LOGDIR -name mysql*err* | xargs` $summary_dir/
      cp `find $ENV_LOGDIR -name mbackup*log* | xargs` $summary_dir/
      for f in $ENV_LOGDIR/vardir/mysql.log $ENV_LOGDIR/vardir1/mysql.log ; do
        cp $f $repro_dir/
      done
      for c in `find $ENV_LOGDIR -name core*` ; do
        echo "#################### $c ####################" >> $summary_dir/stacktraces
        echo "#################### $c ####################" >> $details_dir/threads
        echo "#################### $c ####################" >> $details_dir/threads_full
        binary=`gdb --batch --eval-command="bt" 1 $c 2>&1 | grep 'Core was generated by' | sed -e 's/^Core was generated by \`\([^ ]*\) .*/\1/'`
        echo $binary >> $summary_dir/stacktraces
        echo $binary >> $details_dir/threads
        echo $binary >> $details_dir/threads_full
        gdb --batch --eval-command="bt" $binary $c  | grep -v 'New LWP' >> $summary_dir/stacktraces
        gdb --batch --eval-command="thread apply all bt" $binary $c >> $details_dir/threads
        gdb --batch --eval-command="thread apply all bt full" $binary $c >> $details_dir/threads_full
      done
      tar zcf $details_dir/logs.tar.gz $ENV_LOGDIR
      echo "" >> $summary_dir/test_report
      echo "Test $TEST_ID" >> $summary_dir/test_report
      res=`grep 'exited with exit status' $summary_dir/trial.log | sed -e 's/.*exited with exit status STATUS_\([A-Z_]*\).*/\1/'`
      if [ -z "$res" ] ; then
        res=`grep 'will exit with exit status' $summary_dir/trial.log | sed -e 's/.*will exit with exit status STATUS_\([A-Z_]*\).*/\1/'`
      fi
      echo "Test result:" $res >> $summary_dir/test_report
      echo "Trigger ID:" $(System.DefinitionId)-$(Build.BuildId)-$(Build.BuildNumber).$TEST_ID >> $summary_dir/test_report
      echo "-------------------------------------" >> $summary_dir/test_report
      echo "" >> $summary_dir/test_report
      cp $summary_dir/server.info $repro_dir/repro.info
      rqg_cmd=`grep -A 1 'Final command line' $summary_dir/trial.log | tail -n 1`
      mysqld_options=""
      for o in $rqg_cmd ; do
        if expr match "$o" "--mysqld" > /dev/null ; then
          mysqld_options="$mysqld_options $o"
        fi
      done
      echo "RQG command line: $rqg_cmd" >> $repro_dir/repro.info
      echo "MySQLd options: $mysqld_options" >> $repro_dir/repro.info
      echo `cat $summary_dir/rqg.info` `cat $summary_dir/toolbox.info` >> $summary_dir/test_report
      cat $repro_dir/repro.info >> $summary_dir/test_report
      echo >> $summary_dir/test_report
      if ! perl $ENV_TOOLBOX_DIR/travis/check_for_known_bugs.pl $summary_dir/mysql*.err* $summary_dir/stacktraces >> $summary_dir/test_report ; then
        perl $ENV_TOOLBOX_DIR/travis/check_for_known_bugs.pl $summary_dir/trial.log >> $summary_dir/test_report
      fi
      echo >> $summary_dir/test_report
      for f in $summary_dir/mysql*.err* ; do
        echo "========== $f ==========" >> $summary_dir/test_report
        echo "Throttling:" >> $summary_dir/test_report
        echo `grep -c 'Table .* is marked as crashed and should be repaired' $f` "occurrence(s) of 'Table .* is marked as crashed and should be repaired'" >> $summary_dir/test_report
        echo `grep -c 'mysqld: The table .* is full' $f` "occurrence(s) of 'mysqld: The table .* is full'" >> $summary_dir/test_report
        echo `grep -c 'Failed to load table .* which has a foreign key constraint with table .*' $f` "occurrence(s) of 'Failed to load table .* which has a foreign key constraint with table .*'" >> $summary_dir/test_report
        echo "" >> $summary_dir/test_report
        cat $f | \
          grep -v -f $ENV_TOOLBOX_DIR/travis/server_warnings.supp | \
          grep -v "\[Note\]" | \
          grep -v "\] Query: " | \
          grep -v 'Table .* is marked as crashed and should be repaired' | \
          grep -v 'mysqld: The table .* is full' | \
          grep -v 'Failed to load table .* which has a foreign key constraint with table .*' | \
          grep -v "^$" | \
          cut -c 1-4096 >> $summary_dir/test_report
        echo "" >> $summary_dir/test_report
      done
      echo "#####################################" >> $summary_dir/test_report
      cat $summary_dir/test_report
    displayName: Test result ${{ parameters.TRIAL_NO }}
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
    env:
      PAR_TRIAL_NO: ${{ parameters.TRIAL_NO }}

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: test-$(Build.BuildNumber).$(TEST_ID)
    displayName: Store test result ${{ parameters.TRIAL_NO }}
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
