########################################################################
# Run single RQG test and collect test result information
########################################################################

parameters:
  condition: succeeded()
  continueOnError: true
  TRIAL_ID: ''
  TRIAL_OPTIONS: ''

steps:
  - script: |
      test_id=${PAR_TRIAL_ID:-$SYSTEM_JOBDISPLAYNAME}
      echo "##vso[task.setvariable variable=TEST_ID]$test_id"
    env:
      PAR_TRIAL_ID: ${{ parameters.TRIAL_ID }}
  - script: |
      echo Test ID: $TEST_ID
      mkdir -p $ENV_LOGDIR
      set -xo pipefail
      cd $ENV_RQG_HOME
      perl ./runall-new.pl \
        --basedir=$ENV_BASEDIR \
        --vardir=$ENV_LOGDIR/vardir \
        $ENV_RQG_OPTIONS \
        $PAR_TRIAL_OPTIONS \
        2>&1 | tee $ENV_LOGDIR/trial.log
    name: RQG_test
    displayName: Run RQG test ${{ variables.TEST_ID }}
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
    env:
      PAR_TRIAL_OPTIONS: ${{ parameters.TRIAL_OPTIONS }}

  - template: rqg-test-result.yml
    parameters:
      trial_id: ${{ variables.TEST_ID }}
      condition: ${{ parameters.condition }}
      continueOnError: ${{ parameters.continueOnError }}
