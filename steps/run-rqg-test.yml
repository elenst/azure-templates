########################################################################
# Run single RQG test and collect test result information
########################################################################

parameters:
  condition: succeeded()
  continueOnError: true
  trial_id: $(Agent.jobName)
  TRIAL_OPTIONS: ''

steps:
  - script: |
      mkdir -p $ENV_LOGDIR
      set -xo pipefail
      cd $ENV_RQG_HOME
      perl ./runall-new.pl \
        --basedir=$ENV_BASEDIR \
        --vardir=$ENV_LOGDIR/vardir \
        $ENV_RQG_OPTIONS \
        $PAR_TRIAL_OPTIONS \
        2>&1 | tee $ENV_LOGDIR/trial.log
    name: RQG_test
    displayName: Run RQG test ${{ coalesce(parameters.trial_id,variables['TRIAL_ID']) }}
    condition: ${{ parameters.condition }}
    continueOnError: ${{ parameters.continueOnError }}
    env:
      PAR_TRIAL_OPTIONS: ${{ parameters.TRIAL_OPTIONS }}

  - template: rqg-test-result.yml
    parameters:
      trial_id: ${{ parameters.trial_id }}
      condition: ${{ parameters.condition }}
      continueOnError: ${{ parameters.continueOnError }}
